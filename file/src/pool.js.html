<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/pool.js | node-influx API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/builder.js~Expression.html">Expression</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/builder.js~Measurement.html">Measurement</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/doc.js~Results.html">Results</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/index.js~InfluxDB.html">InfluxDB</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pool.js~Pool.html">Pool</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pool.js~RequestError.html">RequestError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/pool.js~ServiceNotAvailableError.html">ServiceNotAvailableError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/results.js~ResultError.html">ResultError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/src/doc.js~BackoffStrategy.html">BackoffStrategy</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/src/doc.js~NanoDate.html">NanoDate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ClusterConfig">ClusterConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-PingStats">PingStats</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Point">Point</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-PoolOptions">PoolOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-QueryOptions">QueryOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SchemaOptions">SchemaOptions</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-SingleHostConfig">SingleHostConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-WriteOptions">WriteOptions</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">backoff</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/backoff/exponential.js~ExponentialBackoff.html">ExponentialBackoff</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">grammar</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/grammar/ds.js~Raw.html">Raw</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-toNanoDate">toNanoDate</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-escape">escape</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-Precision">Precision</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-FieldType">FieldType</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/pool.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { ExponentialBackoff } from &quot;./backoff/exponential&quot;;
import { Host } from &quot;./host&quot;;
import * as http from &quot;http&quot;;
import * as querystring from &quot;querystring&quot;;
/**
 * Status codes that will cause a host to be marked as &quot;failed&quot; if we get
 * them from a request to Influx.
 * @type {Array}
 */
const resubmitErrorCodes = [
    &quot;ETIMEDOUT&quot;,
    &quot;ESOCKETTIMEDOUT&quot;,
    &quot;ECONNRESET&quot;,
    &quot;ECONNREFUSED&quot;,
    &quot;EHOSTUNREACH&quot;,
];
/**
 * An ServiceNotAvailableError is returned as an error from requests that
 * result in a &gt; 500 error code.
 */
export class ServiceNotAvailableError extends Error {
}
/**
 * An RequestError is returned as an error from requests that
 * result in a 300 &lt;= error code &lt;= 500.
 */
export class RequestError extends Error {
    constructor(req, res, body) {
        super(`A ${res.statusCode} ${res.statusMessage} error occurred: ${body}`);
        this.req = req;
        this.res = res;
    }
    static from(req, res, callback) {
        let body = &quot;&quot;;
        res.on(&quot;data&quot;, str =&gt; body = body + str.toString());
        res.on(&quot;end&quot;, () =&gt; callback(new RequestError(req, res, body)));
    }
}
/**
 * Creates a function generation that returns a wrapper which only allows
 * through the first call of any function that it generated.
 */
function doOnce() {
    let handled = false;
    return fn =&gt; {
        return arg =&gt; {
            if (handled) {
                return;
            }
            handled = true;
            fn(arg);
        };
    };
}
/**
 *
 * The Pool maintains a list available Influx hosts and dispatches requests
 * to them. If there are errors connecting to hosts, it will disable that
 * host for a period of time.
 */
export class Pool {
    /**
     * Creates a new Pool instance.
     * @param {PoolOptions} options
     */
    constructor(options) {
        this.options = Object.assign({
            backoff: new ExponentialBackoff({
                initial: 300,
                max: 10 * 1000,
                random: 1,
            }),
            maxRetries: 2,
            requestTimeout: 30 * 1000,
        }, options);
        this.index = 0;
        this.hostsAvailable = new Set();
        this.hostsDisabled = new Set();
        this.timeout = this.options.requestTimeout;
    }
    /**
     * Returns a list of currently active hosts.
     * @return {Host[]}
     */
    getHostsAvailable() {
        return Array.from(this.hostsAvailable);
    }
    /**
     * Returns a list of hosts that are currently disabled due to network
     * errors.
     * @return {Host[]}
     */
    getHostsDisabled() {
        return Array.from(this.hostsDisabled);
    }
    /**
     * Inserts a new host to the pool.
     */
    addHost(url) {
        const host = new Host(url, this.options.backoff.reset());
        this.hostsAvailable.add(host);
        return host;
    }
    /**
     * Returns true if there&quot;s any host available to by queried.
     * @return {Boolean}
     */
    hostIsAvailable() {
        return this.hostsAvailable.size &gt; 0;
    }
    /**
     * Makes a request and calls back with the response, parsed as JSON.
     * An error is returned on a non-2xx status code or on a parsing exception.
     */
    json(options) {
        return this.text(options).then(res =&gt; JSON.parse(res));
    }
    /**
     * Makes a request and resolves with the plain text response,
     * if possible. An error is raised on a non-2xx status code.
     */
    text(options) {
        return new Promise((resolve, reject) =&gt; {
            this.stream(options, (err, res) =&gt; {
                if (err) {
                    return reject(err);
                }
                let output = &quot;&quot;;
                res.on(&quot;data&quot;, str =&gt; output = output + str.toString());
                res.on(&quot;end&quot;, () =&gt; resolve(output));
            });
        });
    }
    /**
     * Makes a request and discards any response body it receives.
     * An error is returned on a non-2xx status code.
     */
    discard(options) {
        return new Promise((resolve, reject) =&gt; {
            this.stream(options, (err, res) =&gt; {
                if (err) {
                    return reject(err);
                }
                res.on(&quot;data&quot;, () =&gt; { });
                res.on(&quot;end&quot;, () =&gt; resolve());
            });
        });
    }
    /**
     * Ping sends out a request to all available Influx servers, reporting on
     * their response time and version number.
     */
    ping(timeout, path = &quot;/ping&quot;) {
        let todo = [];
        [...this.hostsAvailable, ...this.hostsDisabled].forEach(host =&gt; {
            const start = Date.now();
            const url = host.url;
            const once = doOnce();
            return todo.push(new Promise(resolve =&gt; {
                const req = http.request({
                    hostname: url.hostname,
                    method: &quot;GET&quot;,
                    path,
                    port: Number(url.port),
                    protocol: url.protocol,
                    timeout,
                }, once((res) =&gt; {
                    resolve({
                        url,
                        res,
                        online: res.statusCode &lt; 300,
                        rtt: Date.now() - start,
                        version: res.headers[&quot;x-influxdb-version&quot;],
                    });
                }));
                const fail = once(() =&gt; {
                    resolve({
                        online: false,
                        res: null,
                        rtt: Infinity,
                        url,
                        version: null,
                    });
                });
                // Support older Nodes and polyfills which don&apos;t allow .timeout() in
                // the request options, wrapped in a conditional for even worse
                // polyfills. See: https://github.com/node-influx/node-influx/issues/221
                if (typeof req.setTimeout === &quot;function&quot;) {
                    req.setTimeout(timeout, fail);
                }
                req.on(&quot;timeout&quot;, fail);
                req.on(&quot;error&quot;, fail);
                req.end();
            }));
        });
        return Promise.all(todo);
    }
    /**
     * Makes a request and calls back with the IncomingMessage stream,
     * if possible. An error is returned on a non-2xx status code.
     */
    stream(options, callback) {
        if (!this.hostIsAvailable()) {
            return callback(new ServiceNotAvailableError(&quot;No host available&quot;), null);
        }
        let path = options.path;
        if (options.query) {
            path += &quot;?&quot; + querystring.stringify(options.query);
        }
        const once = doOnce();
        const host = this.getHost();
        const req = http.request({
            headers: { &quot;content-length&quot;: options.body ? options.body.length : 0 },
            hostname: host.url.hostname,
            method: options.method,
            path,
            port: Number(host.url.port),
            protocol: host.url.protocol,
            timeout: this.timeout,
        }, once((res) =&gt; {
            if (res.statusCode &gt;= 500) {
                return this.handleRequestError(new ServiceNotAvailableError(res.statusMessage), host, options, callback);
            }
            if (res.statusCode &gt;= 300) {
                return RequestError.from(req, res, err =&gt; callback(err, res));
            }
            host.success();
            return callback(undefined, res);
        }));
        // Handle network or HTTP parsing errors:
        req.on(&quot;error&quot;, once(err =&gt; {
            this.handleRequestError(err, host, options, callback);
        }));
        // Handle timeouts:
        req.on(&quot;timeout&quot;, once(() =&gt; {
            this.handleRequestError(new ServiceNotAvailableError(&quot;Request timed out&quot;), host, options, callback);
        }));
        // Support older Nodes and polyfills which don&apos;t allow .timeout() in the
        // request options, wrapped in a conditional for even worse polyfills. See:
        // https://github.com/node-influx/node-influx/issues/221
        if (typeof req.setTimeout === &quot;function&quot;) {
            req.setTimeout(this.timeout);
        }
        // Write out the body:
        if (options.body) {
            req.write(options.body);
        }
        req.end();
    }
    /**
     * Returns the next available host for querying.
     * @return {Host}
     */
    getHost() {
        const available = Array.from(this.hostsAvailable);
        const host = available[this.index];
        this.index = (this.index + 1) % available.length;
        return host;
    }
    /**
     * Re-enables the provided host, returning it to the pool to query.
     * @param  {Host} host
     */
    enableHost(host) {
        this.hostsDisabled.delete(host);
        this.hostsAvailable.add(host);
    }
    /**
     * Disables the provided host, removing it from the query pool. It will be
     * re-enabled after a backoff interval
     */
    disableHost(host) {
        this.hostsAvailable.delete(host);
        this.hostsDisabled.add(host);
        this.index %= Math.max(1, this.hostsAvailable.size);
        setTimeout(() =&gt; this.enableHost(host), host.fail());
    }
    handleRequestError(err, host, options, callback) {
        if (!(err instanceof ServiceNotAvailableError) &amp;&amp;
            resubmitErrorCodes.indexOf(err.code) === -1) {
            return callback(err, null);
        }
        this.disableHost(host);
        const retries = options.retries || 0;
        if (retries &lt; this.options.maxRetries &amp;&amp; this.hostIsAvailable()) {
            options.retries = retries + 1;
            return this.stream(options, callback);
        }
        callback(err, null);
    }
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
